<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Gastos</title>
  <!-- Incluir Firebase compat (forma sencilla) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    /* Global */
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* PestaÃ±as */
    #tabContainer { display: flex; margin-bottom: 10px; }
    .tab {
      flex: 1;
      padding: 8px 0;
      text-align: center;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
      font-size: 0.9em;
    }
    .tab.active { background-color: #fff; font-weight: bold; }
    /* Pantallas */
    .screen { border: 1px solid #ccc; padding: 10px; display: none; }
    .screen.active { display: block; }
    /* Cabeceras */
    #headerContainer, #headerContainerCredit, #headerContainerOtros { text-align: left; margin-bottom: 20px; }
    #title, #titleCredit, #titleOtros { margin: 0; text-decoration: underline; font-size: 1.5em; }
    #monthInfo, #monthInfoCredit, #monthInfoOtros { margin: 0; font-size: 1.2em; }
    /* Tablas */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    /* Principal: 30% Concepto, 50% Monto, 20% Acciones */
    /* Nota: Usamos <col> dentro de <colgroup> correctamente */
    <colgroup id="cgPrincipal">
      <col style="width:30%;">
      <col style="width:50%;">
      <col style="width:20%;">
    </colgroup>
    /* Tarjeta de CrÃ©dito: 40% Concepto, 40% Monto, 20% Cuotas */
    <colgroup id="cgCredit">
      <col style="width:40%;">
      <col style="width:40%;">
      <col style="width:20%;">
    </colgroup>
    /* Otros gastos: 50% Concepto, 50% Monto */
    <colgroup id="cgOtros">
      <col style="width:50%;">
      <col style="width:50%;">
    </colgroup>
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; vertical-align: middle; word-wrap: break-word; }
    /* Centrar columna de Cuotas en Tarjeta de CrÃ©dito */
    #expensesTableCredit td:nth-child(3) { text-align: center; }
    /* Botones */
    .icon-button { border: none; background: none; padding: 0 5px; font-size: 0.65em; cursor: pointer; }
    .icon-button:disabled { cursor: default; }
    .pay-icon { font-size: 1.3em; display: block; margin: auto; }
    /* Inputs inline */
    input[type="text"], input[type="number"] { padding: 5px; font-size: 1em; margin: 2px; width: 100%; box-sizing: border-box; }
    /* SecciÃ³n para agregar nuevo gasto */
    .addExpenseContainer { margin-top: 20px; text-align: left; }
    .addExpenseContainer h3 { margin-bottom: 10px; }
    .newConcept { width: 60%; }
    .newAmount { width: 30%; }
    .newCuotas { width: 20%; margin-left: 5px; }
    /* Resumen */
    .summaryBox { border: 2px solid #ccc; padding: 10px; margin-top: 20px; border-radius: 5px; text-align: left; font-size: 1.1em; }
    .summaryBox p { margin: 5px 0; }
    /* Respaldos */
    .backupContainer { margin-top: 20px; }
    .export-btn, .import-btn { padding: 5px 10px; font-size: 1em; cursor: pointer; margin-right: 10px; }
  </style>
</head>
<body>
  <!-- PROTECCIÃ“N POR CONTRASEÃ‘A -->
  <script>
    var user = prompt("Ingrese usuario:");
    var pass = prompt("Ingrese contraseÃ±a:");
    if(user !== "Calzolari" || pass !== "ClaraVera2025") {
      alert("Credenciales incorrectas. Acceso denegado.");
      document.body.innerHTML = "<h1>Acceso denegado</h1>";
      throw new Error("Acceso denegado");
    }
  </script>

  <!-- PestaÃ±as -->
  <div id="tabContainer">
    <span id="tabPrincipal" class="tab active">Principal</span>
    <span id="tabCredit" class="tab">Tarj. de credit.</span>
    <span id="tabOtros" class="tab">Otros gastos</span>
  </div>

  <!-- Pantalla PRINCIPAL -->
  <div id="screenPrincipal" class="screen active">
    <div id="headerContainer">
      <h1 id="title">Control de gastos</h1>
      <p id="monthInfo">Mes en curso: <span id="currentMonthDisplayPrincipal"></span></p>
      <div id="historialContainerPrincipal">
        <label for="monthSelectPrincipal">Historial:</label>
        <select id="monthSelectPrincipal"></select>
      </div>
    </div>
    <table id="expensesTablePrincipal">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerPrincipal">
      <h3>Agregar nuevo gasto</h3>
      <input type="text" id="newConceptPrincipal" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountPrincipal" class="newAmount" placeholder="Monto">
      <button id="addExpenseButtonPrincipal">âž• Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxPrincipal"></div>
    <!-- Respaldos -->
    <div class="backupContainer">
      <button id="exportBackupButton" class="export-btn">Exportar respaldo</button>
      <button id="importBackupButton" class="import-btn">Importar respaldo</button>
      <input type="file" id="backupFileInput" style="display:none" accept=".json">
    </div>
  </div>

  <!-- Pantalla TARJ. DE CREDIT. -->
  <div id="screenCredit" class="screen">
    <div id="headerContainerCredit">
      <h1 id="titleCredit">Tarj. de credit.</h1>
      <p id="monthInfoCredit">Mes: <span id="currentMonthDisplayCredit"></span></p>
    </div>
    <table id="expensesTableCredit">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Cuotas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerCredit">
      <h3>Agregar gasto de Tarj. de credit.</h3>
      <input type="text" id="newConceptCredit" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountCredit" class="newAmount" placeholder="Monto">
      <input type="text" id="newCuotasCredit" class="newCuotas" placeholder="Cuotas (ej: 1/6)">
      <button id="addExpenseButtonCredit">âž• Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxCredit"></div>
  </div>

  <!-- Pantalla OTROS GASTOS -->
  <div id="screenOtros" class="screen">
    <div id="headerContainerOtros">
      <h1 id="titleOtros">Otros gastos</h1>
      <p id="monthInfoOtros">Mes: <span id="currentMonthDisplayOtros"></span></p>
    </div>
    <table id="expensesTableOtros">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerOtros">
      <h3>Agregar otro gasto</h3>
      <input type="text" id="newConceptOtros" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountOtros" class="newAmount" placeholder="Monto">
      <button id="addExpenseButtonOtros">âž• Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxOtros"></div>
  </div>

  <script>
    // Inicializar Firebase (compat)
    const firebaseConfig = {
      apiKey: "AIzaSyCcaWnZquoQuzcaLwPMLL-G8dhhpZ61sGg",
      authDomain: "contrl-gastos-app.firebaseapp.com",
      projectId: "contrl-gastos-app",
      storageBucket: "contrl-gastos-app.firebasestorage.app",
      messagingSenderId: "544153383458",
      appId: "1:544153383458:web:ab395573cefcb6b3ed507b",
      measurementId: "G-1E3KH675HF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    document.addEventListener("DOMContentLoaded", function() {
      
      // FunciÃ³n para formatear nÃºmeros
      function formatNumber(num) {
        return new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
      }
      
      /* VARIABLES */
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth(); // 0-indexado
      const currentMonthName = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][currentMonth];
      const keyPrincipal = `expenses_${currentYear}_${currentMonth+1}`;
      const keyCredit = `credit_${currentYear}_${currentMonth+1}`;
      const keyOtros = `others_${currentYear}_${currentMonth+1}`;
      
      /* DATOS POR DEFECTO */
      const defaultPrincipal = [
        { concept: "Luz", amount: 50, paid: false },
        { concept: "Gas", amount: 30, paid: false },
        { concept: "Tarjeta de CrÃ©dito", amount: 0, paid: false },
        { concept: "Agua", amount: 25, paid: false },
        { concept: "Internet", amount: 40, paid: false }
      ];
      const defaultCredit = [];
      const defaultOtros = [];
      
      /* LOCAL STORAGE */
      function loadData(key, defaultData, prefix) {
        const stored = localStorage.getItem(key);
        if (stored) return JSON.parse(stored);
        else {
          if(prefix === "others") {
            localStorage.setItem(key, JSON.stringify([]));
            return [];
          } else if(prefix === "credit") {
            let parts = key.split("_");
            let month = parseInt(parts[2]);
            let prevKey = month === 1 ? `${prefix}_${parts[1]-1}_12` : `${prefix}_${parts[1]}_${month-1}`;
            let prevData = localStorage.getItem(prevKey);
            if (prevData) {
              let data = JSON.parse(prevData)
                .filter(item => item.fixed === true || item.hasOwnProperty("cuotas"))
                .map(item => {
                  let newItem = { ...item, paid: false };
                  if(newItem.hasOwnProperty("cuotas")) {
                    let [currentCuota, totalCuotas] = newItem.cuotas.split("/").map(Number);
                    currentCuota++;
                    if(currentCuota > totalCuotas) return null;
                    else newItem.cuotas = currentCuota + "/" + totalCuotas;
                  }
                  return newItem;
                }).filter(item => item !== null);
              localStorage.setItem(key, JSON.stringify(data));
              return data;
            }
            localStorage.setItem(key, JSON.stringify(defaultData));
            return JSON.parse(JSON.stringify(defaultData));
          } else { // expenses
            let parts = key.split("_");
            let month = parseInt(parts[2]);
            let prevKey = month === 1 ? `${prefix}_${parts[1]-1}_12` : `${prefix}_${parts[1]}_${month-1}`;
            let prevData = localStorage.getItem(prevKey);
            if (prevData) {
              let data = JSON.parse(prevData).map(item => ({ ...item, paid: false }));
              localStorage.setItem(key, JSON.stringify(data));
              return data;
            }
            localStorage.setItem(key, JSON.stringify(defaultData));
            return JSON.parse(JSON.stringify(defaultData));
          }
        }
      }
      function saveData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
      
      let principalData = loadData(keyPrincipal, defaultPrincipal, "expenses");
      let creditData = loadData(keyCredit, defaultCredit, "credit");
      let othersData = loadData(keyOtros, defaultOtros, "others");
      
      let editable = true;
      function computeSum(data) { return data.reduce((sum, exp) => sum + parseFloat(exp.amount), 0); }
      
      // Firestore: Guardar y cargar
      function guardarDatosEnFirestore() {
        db.collection("data").doc("control_gastos").set({
          principal: principalData,
          credit: creditData,
          others: othersData
        })
        .then(() => console.log("Datos guardados en Firestore"))
        .catch(error => console.error("Error al guardar datos: ", error));
      }
      function cargarDatosDesdeFirestore() {
        db.collection("data").doc("control_gastos").get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              principalData = data.principal || defaultPrincipal;
              creditData = data.credit || defaultCredit;
              othersData = data.others || defaultOtros;
              saveData(keyPrincipal, principalData);
              saveData(keyCredit, creditData);
              saveData(keyOtros, othersData);
              renderPrincipal();
              renderCredit();
              renderOthers();
            } else { console.log("No existe documento en Firestore"); }
          })
          .catch(error => console.error("Error al cargar datos: ", error));
      }
      cargarDatosDesdeFirestore();
      
      // Alternar "fixed" en Tarj. de crÃ©dito
      function toggleFixed(expense, cell) {
        if(expense.hasOwnProperty("cuotas")) return;
        if(expense.fixed === true && !confirm("Â¿Desmarcar gasto fijo?")) return;
        expense.fixed = !expense.fixed;
        cell.style.backgroundColor = expense.fixed ? "orange" : "";
        saveData(keyCredit, creditData);
        guardarDatosEnFirestore();
      }
      
      function inlineEditCell(cell, expense, field, index, renderCallback, key, dataArray) {
        if(cell.querySelector("input")) return;
        let currentValue = expense[field].toString();
        let input = document.createElement("input");
        input.type = (field === "amount") ? "number" : "text";
        input.value = currentValue;
        cell.innerHTML = "";
        cell.appendChild(input);
        input.focus();
        input.addEventListener("keydown", e => { if(e.key === "Enter") input.blur(); });
        input.addEventListener("blur", () => {
          let newValue = input.value.trim();
          if(newValue === "") {
            if(confirm("Â¿Eliminar este registro?")) {
              dataArray.splice(index, 1);
              saveData(key, dataArray);
              renderCallback();
              guardarDatosEnFirestore();
            } else { cell.innerHTML = currentValue; }
          } else {
            expense[field] = (field === "amount") ? parseFloat(newValue) : newValue;
            saveData(key, dataArray);
            renderCallback();
            guardarDatosEnFirestore();
          }
        });
      }
      
      /* Manejo de pestaÃ±as */
      document.getElementById("tabPrincipal").addEventListener("click", () => { setActiveTab("Principal"); });
      document.getElementById("tabCredit").addEventListener("click", () => { setActiveTab("Credit"); });
      document.getElementById("tabOtros").addEventListener("click", () => { setActiveTab("Otros"); });
      function setActiveTab(tab) {
        document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".screen").forEach(el => el.classList.remove("active"));
        if(tab === "Principal") {
          document.getElementById("tabPrincipal").classList.add("active");
          document.getElementById("screenPrincipal").classList.add("active");
          renderPrincipal();
        } else if(tab === "Credit") {
          document.getElementById("tabCredit").classList.add("active");
          document.getElementById("screenCredit").classList.add("active");
          renderCredit();
        } else if(tab === "Otros") {
          document.getElementById("tabOtros").classList.add("active");
          document.getElementById("screenOtros").classList.add("active");
          renderOthers();
        }
      }
      
      /* Selector de historial */
      function populateMonthSelect(selectId, keyDefault) {
        const select = document.getElementById(selectId);
        select.innerHTML = "";
        const option = document.createElement("option");
        option.value = keyDefault;
        option.textContent = `${currentMonthName} ${currentYear}`;
        option.selected = true;
        select.appendChild(option);
      }
      populateMonthSelect("monthSelectPrincipal", keyPrincipal);
      
      document.getElementById("currentMonthDisplayPrincipal").textContent = `${currentMonthName} ${currentYear}`;
      document.getElementById("currentMonthDisplayCredit").textContent = `${currentMonthName} ${currentYear}`;
      document.getElementById("currentMonthDisplayOtros").textContent = `${currentMonthName} ${currentYear}`;
      
      document.getElementById("monthSelectPrincipal").addEventListener("change", function(){
        let selectedKey = this.value;
        principalData = loadData(selectedKey, defaultPrincipal, "expenses");
        let parts = selectedKey.split("_");
        let creditKey = `credit_${parts[1]}_${parts[2]}`;
        let othersKey = `others_${parts[1]}_${parts[2]}`;
        creditData = loadData(creditKey, defaultCredit, "credit");
        othersData = loadData(othersKey, defaultOtros, "others");
        editable = (selectedKey === keyPrincipal);
        renderPrincipal();
      });
      
      // ---------------------------
      // Datos ficticios para marzo: Si es abril y no hay datos, se inserta 1.856.934.
      if(currentMonth === 3 && !localStorage.getItem(`credit_${currentYear}_3`)) {
        const fictitiousMarch = [
          { concept: "Gastos Fijos", amount: 1856934, paid: true, fixed: true }
        ];
        localStorage.setItem(`credit_${currentYear}_3`, JSON.stringify(fictitiousMarch));
      }
      // ---------------------------
      
      // ---------------------------
      // En Principal, la fila "Tarjeta de CrÃ©dito" usa datos del mes anterior.
      function getPrevCreditKey() {
        return currentMonth === 0 ? `credit_${currentYear-1}_12` : `credit_${currentYear}_${currentMonth}`;
      }
      // ---------------------------
      
      /* Renderizado de Principal */
      function renderPrincipal() {
        const tbody = document.querySelector("#expensesTablePrincipal tbody");
        tbody.innerHTML = "";
        const prevCreditKey = getPrevCreditKey();
        let prevCreditData = JSON.parse(localStorage.getItem(prevCreditKey) || "[]");
        let creditSum = computeSum(prevCreditData);
        let allCreditPaid = prevCreditData.length > 0 && prevCreditData.every(exp => exp.paid);
        
        let creditRow = null, otherRows = [];
        principalData.forEach((expense, index) => {
          if(expense.concept === "Tarjeta de CrÃ©dito") creditRow = { expense, index };
          else otherRows.push({ expense, index });
        });
        
        if(creditRow) {
          const row = document.createElement("tr");
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const actionsCell = document.createElement("td");
          conceptCell.textContent = creditRow.expense.concept;
          amountCell.textContent = "$ " + formatNumber(creditSum);
          const statusButton = document.createElement("button");
          statusButton.innerHTML = allCreditPaid ? "âœ…" : "ðŸ’²";
          statusButton.style.color = allCreditPaid ? "#27ae60" : "#e74c3c";
          statusButton.title = allCreditPaid ? "Pagado (click para revertir)" : "Pagar";
          statusButton.classList.add("icon-button", "pay-icon");
          statusButton.addEventListener("click", function() {
            if(allCreditPaid) {
              if(confirm("Â¿EstÃ¡ segura que quiere cambiar a 'no pagado'?")) {
                prevCreditData.forEach(exp => exp.paid = false);
              }
            } else {
              prevCreditData.forEach(exp => exp.paid = true);
            }
            localStorage.setItem(prevCreditKey, JSON.stringify(prevCreditData));
            renderPrincipal();
          });
          actionsCell.appendChild(statusButton);
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        }
        
        otherRows.forEach(({ expense, index }) => {
          const row = document.createElement("tr");
          if(editable) {
            row.addEventListener("mousedown", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿EstÃ¡ segura de eliminar este registro?")) {
                  principalData.splice(index, 1);
                  saveData(keyPrincipal, principalData);
                  renderPrincipal();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("touchstart", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿EstÃ¡ segura de eliminar este registro?")) {
                  principalData.splice(index, 1);
                  saveData(keyPrincipal, principalData);
                  renderPrincipal();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          }
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const actionsCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          conceptCell.addEventListener("click", () => {
            inlineEditCell(conceptCell, expense, "concept", index, renderPrincipal, keyPrincipal, principalData);
          });
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          amountCell.addEventListener("click", () => {
            inlineEditCell(amountCell, expense, "amount", index, renderPrincipal, keyPrincipal, principalData);
          });
          const payButton = document.createElement("button");
          payButton.innerHTML = expense.paid ? "âœ…" : "ðŸ’²";
          payButton.style.color = expense.paid ? "#27ae60" : "#e74c3c";
          payButton.title = expense.paid ? "Pagado (click para revertir)" : "Pagar";
          payButton.classList.add("icon-button", "pay-icon");
          payButton.addEventListener("click", () => {
            if(expense.paid) {
              if(confirm("Â¿EstÃ¡ segura que quiere cambiar a 'no pagado'?")) { expense.paid = false; }
            } else { expense.paid = true; }
            saveData(keyPrincipal, principalData);
            renderPrincipal();
            guardarDatosEnFirestore();
          });
          actionsCell.appendChild(payButton);
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });
        
        // Fila fija "Otros gastos"
        const rowOtros = document.createElement("tr");
        const conceptCellOtros = document.createElement("td");
        conceptCellOtros.textContent = "Otros gastos";
        const amountCellOtros = document.createElement("td");
        amountCellOtros.textContent = "$ " + formatNumber(computeSum(othersData));
        const actionsCellOtros = document.createElement("td");
        const allOthersPaid = othersData.length > 0 && othersData.every(exp => exp.paid);
        const othersPayButton = document.createElement("button");
        othersPayButton.innerHTML = allOthersPaid ? "âœ…" : "ðŸ’²";
        othersPayButton.style.color = allOthersPaid ? "#27ae60" : "#e74c3c";
        othersPayButton.title = allOthersPaid ? "Pagado (click para revertir)" : "Pagar";
        othersPayButton.classList.add("icon-button", "pay-icon");
        othersPayButton.addEventListener("click", () => {
          if(allOthersPaid) {
            if(confirm("Â¿EstÃ¡ segura que quiere cambiar a 'no pagado'?")) {
              othersData.forEach(exp => exp.paid = false);
            }
          } else {
            othersData.forEach(exp => exp.paid = true);
          }
          saveData(keyOtros, othersData);
          renderPrincipal();
          renderOthers();
          guardarDatosEnFirestore();
        });
        actionsCellOtros.appendChild(othersPayButton);
        rowOtros.appendChild(conceptCellOtros);
        rowOtros.appendChild(amountCellOtros);
        rowOtros.appendChild(actionsCellOtros);
        tbody.appendChild(rowOtros);
        
        updateSummaryPrincipal();
        
        // Formulario Principal
        const container = document.getElementById("addExpenseContainerPrincipal");
        container.innerHTML = `
          <h3>Agregar nuevo gasto</h3>
          <input type="text" id="newConceptPrincipal" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountPrincipal" class="newAmount" placeholder="Monto">
          <button id="addExpenseButtonPrincipal">âž• Agregar</button>
        `;
        document.getElementById("addExpenseButtonPrincipal").addEventListener("click", () => {
          const conceptInput = document.getElementById("newConceptPrincipal");
          const amountInput = document.getElementById("newAmountPrincipal");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto vÃ¡lido y un monto positivo.");
            return;
          }
          principalData.push({ concept, amount, paid: false });
          saveData(keyPrincipal, principalData);
          conceptInput.value = "";
          amountInput.value = "";
          renderPrincipal();
          guardarDatosEnFirestore();
        });
      }
      
      function updateSummaryPrincipal() {
        let total = 0, pending = 0;
        principalData.forEach(exp => {
          if(exp.concept === "Tarjeta de CrÃ©dito") {
            total += creditData.length > 0 ? computeSum(creditData) : 0;
            if(!(creditData.length > 0 && creditData.every(e => e.paid)))
              pending += creditData.length > 0 ? computeSum(creditData) : 0;
          } else {
            total += parseFloat(exp.amount);
            if(!exp.paid) pending += parseFloat(exp.amount);
          }
        });
        let othersTotal = computeSum(othersData);
        total += othersTotal;
        if(!(othersData.length > 0 && othersData.every(exp => exp.paid)))
          pending += othersTotal;
        let summaryHTML = `<p>ðŸ’° Total a pagar: $${formatNumber(total)}</p>
                           <p>ðŸ•’ Falta pagar: $${formatNumber(pending)}</p>`;
        summaryHTML += pending > 0 ? `<button id="payAllButtonPrincipal" class="icon-button">ðŸ’¸ Pagar todo</button>` : `<p>âœ… Â¡Todo pagado!</p>`;
        document.getElementById("summaryBoxPrincipal").innerHTML = summaryHTML;
        document.getElementById("summaryBoxPrincipal").style.backgroundColor = pending > 0 ? "#ffebee" : "#e0ffe0";
        const payAllButton = document.getElementById("payAllButtonPrincipal");
        if(payAllButton) {
          payAllButton.addEventListener("click", () => {
            principalData.forEach(exp => { if(exp.concept !== "Tarjeta de CrÃ©dito") exp.paid = true; });
            saveData(keyPrincipal, principalData);
            renderPrincipal();
            guardarDatosEnFirestore();
          });
        }
      }
      
      /* Renderizado de Tarjeta de CrÃ©dito */
      function renderCredit() {
        const tbody = document.querySelector("#expensesTableCredit tbody");
        tbody.innerHTML = "";
        creditData.forEach((expense, index) => {
          const row = document.createElement("tr");
          if(editable) {
            row.addEventListener("mousedown", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿Eliminar este registro?")) {
                  creditData.splice(index, 1);
                  saveData(keyCredit, creditData);
                  renderCredit();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("touchstart", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿Eliminar este registro?")) {
                  creditData.splice(index, 1);
                  saveData(keyCredit, creditData);
                  renderCredit();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          }
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const cuotasCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          conceptCell.addEventListener("click", () => {
            if(expense.hasOwnProperty("cuotas")) return;
            toggleFixed(expense, conceptCell);
          });
          conceptCell.style.backgroundColor = (expense.fixed || expense.hasOwnProperty("cuotas")) ? "orange" : "";
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          updateCreditAmountCellStyle(expense, amountCell);
          amountCell.addEventListener("click", () => {
            if(expense.paid) {
              if(!confirm("Â¿Desmarcar este pago?")) return;
              expense.paid = false;
            } else { expense.paid = true; }
            saveData(keyCredit, creditData);
            updateCreditAmountCellStyle(expense, amountCell);
          });
          cuotasCell.textContent = expense.hasOwnProperty("cuotas") ? expense.cuotas : "";
          cuotasCell.addEventListener("click", () => {
            inlineEditCell(cuotasCell, expense, "cuotas", index, renderCredit, keyCredit, creditData);
          });
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(cuotasCell);
          tbody.appendChild(row);
        });
        updateSummaryCredit();
        const container = document.getElementById("addExpenseContainerCredit");
        container.innerHTML = `
          <h3>Agregar gasto de Tarj. de credit.</h3>
          <input type="text" id="newConceptCredit" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountCredit" class="newAmount" placeholder="Monto">
          <input type="text" id="newCuotasCredit" class="newCuotas" placeholder="Cuotas (ej: 1/6)">
          <button id="addExpenseButtonCredit">âž• Agregar</button>
        `;
        document.getElementById("addExpenseButtonCredit").addEventListener("click", () => {
          console.log("Agregar Tarj. de credit.");
          const conceptInput = document.getElementById("newConceptCredit");
          const amountInput = document.getElementById("newAmountCredit");
          const cuotasInput = document.getElementById("newCuotasCredit");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          const cuotas = cuotasInput.value.trim();
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto vÃ¡lido y un monto positivo.");
            return;
          }
          let newExpense = { concept, amount, paid: false };
          if(cuotas !== "") { newExpense.cuotas = cuotas; newExpense.fixed = true; }
          creditData.push(newExpense);
          saveData(keyCredit, creditData);
          conceptInput.value = "";
          amountInput.value = "";
          cuotasInput.value = "";
          renderCredit();
          renderPrincipal();
          guardarDatosEnFirestore();
        });
      }
      
      function updateSummaryCredit() {
        let total = creditData.length > 0 ? computeSum(creditData) : 0;
        let summaryHTML = `<p>ðŸ’° Total Tarj. de credit: $${formatNumber(total)}</p>`;
        document.getElementById("summaryBoxCredit").innerHTML = summaryHTML;
        document.getElementById("summaryBoxCredit").style.backgroundColor = "#e0ffe0";
      }
      
      /* Renderizado de Otros gastos */
      function renderOthers() {
        const tbody = document.querySelector("#expensesTableOtros tbody");
        tbody.innerHTML = "";
        othersData.forEach((expense, index) => {
          const row = document.createElement("tr");
          if(editable) {
            row.addEventListener("mousedown", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿Eliminar este registro?")) {
                  othersData.splice(index, 1);
                  saveData(keyOtros, othersData);
                  renderOthers();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("touchstart", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("Â¿Eliminar este registro?")) {
                  othersData.splice(index, 1);
                  saveData(keyOtros, othersData);
                  renderOthers();
                  guardarDatosEnFirestore();
                }
              }, 1000);
            });
            row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          }
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          conceptCell.addEventListener("click", () => {
            inlineEditCell(conceptCell, expense, "concept", index, renderOthers, keyOtros, othersData);
          });
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          amountCell.addEventListener("click", () => {
            inlineEditCell(amountCell, expense, "amount", index, renderOthers, keyOtros, othersData);
          });
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          tbody.appendChild(row);
        });
        updateSummaryOthers();
        const container = document.getElementById("addExpenseContainerOtros");
        container.innerHTML = `
          <h3>Agregar otro gasto</h3>
          <input type="text" id="newConceptOtros" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountOtros" class="newAmount" placeholder="Monto">
          <button id="addExpenseButtonOtros">âž• Agregar</button>
        `;
        document.getElementById("addExpenseButtonOtros").addEventListener("click", () => {
          const conceptInput = document.getElementById("newConceptOtros");
          const amountInput = document.getElementById("newAmountOtros");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto vÃ¡lido y un monto positivo.");
            return;
          }
          othersData.push({ concept, amount, paid: false });
          saveData(keyOtros, othersData);
          conceptInput.value = "";
          amountInput.value = "";
          renderOthers();
          guardarDatosEnFirestore();
        });
      }
      
      document.getElementById("addExpenseButtonPrincipal").addEventListener("click", () => {
        const conceptInput = document.getElementById("newConceptPrincipal");
        const amountInput = document.getElementById("newAmountPrincipal");
        const concept = conceptInput.value.trim();
        const amount = parseFloat(amountInput.value);
        if(concept === "" || isNaN(amount) || amount < 0) {
          alert("Ingresa un concepto vÃ¡lido y un monto positivo.");
          return;
        }
        principalData.push({ concept, amount, paid: false });
        saveData(keyPrincipal, principalData);
        conceptInput.value = "";
        amountInput.value = "";
        renderPrincipal();
        guardarDatosEnFirestore();
      });
      
      /* Respaldos */
      function exportBackup() {
        const backupData = { principal: principalData, credit: creditData, others: othersData };
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `respaldo_${currentYear}_${currentMonth+1}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      function importBackup(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if(data.principal && data.credit && data.others) {
              localStorage.setItem(keyPrincipal, JSON.stringify(data.principal));
              localStorage.setItem(keyCredit, JSON.stringify(data.credit));
              localStorage.setItem(keyOtros, JSON.stringify(data.others));
              principalData = data.principal;
              creditData = data.credit;
              othersData = data.others;
              renderPrincipal();
              renderCredit();
              renderOthers();
              alert("Respaldo importado exitosamente.");
            } else { alert("El archivo no contiene datos vÃ¡lidos."); }
          } catch (err) { alert("Error al leer el archivo."); }
        };
        reader.readAsText(file);
      }
      document.getElementById("exportBackupButton").addEventListener("click", exportBackup);
      document.getElementById("importBackupButton").addEventListener("click", () => {
        document.getElementById("backupFileInput").click();
      });
      document.getElementById("backupFileInput").addEventListener("change", e => {
        if(e.target.files.length > 0) importBackup(e.target.files[0]);
      });
      
      /* ExportaciÃ³n automÃ¡tica el primer dÃ­a de cada mes */
      if(new Date().getDate() === 1) { exportBackup(); }
      
      // Datos ficticios para marzo: Si es abril y no existen datos para marzo en Tarj. de crÃ©dito
      if(currentMonth === 3 && !localStorage.getItem(`credit_${currentYear}_3`)) {
        const fictitiousMarch = [{ concept: "Gastos Fijos", amount: 1856934, paid: true, fixed: true }];
        localStorage.setItem(`credit_${currentYear}_3`, JSON.stringify(fictitiousMarch));
      }
      
      // Activar pestaÃ±a Principal al iniciar
      setActiveTab("Principal");
    });
  </script>
</body>
</html>
