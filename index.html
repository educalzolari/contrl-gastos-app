<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Gastos</title>
  <style>
    /* Global */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Pesta√±as */
    #tabContainer {
      display: flex;
      margin-bottom: 10px;
    }
    .tab {
      flex: 1;
      padding: 8px 0;
      text-align: center;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #f1f1f1;
      font-size: 0.9em;
    }
    .tab.active {
      background-color: #fff;
      font-weight: bold;
    }
    /* Pantallas */
    .screen {
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
    }
    .screen.active {
      display: block;
    }
    /* Cabeceras */
    #headerContainer, #headerContainerCredit, #headerContainerOtros {
      text-align: left;
      margin-bottom: 20px;
    }
    #title, #titleCredit, #titleOtros {
      margin: 0;
      text-decoration: underline;
      font-size: 1.5em;
    }
    #monthInfo, #monthInfoCredit, #monthInfoOtros {
      margin: 0;
      font-size: 1.2em;
    }
    /* Tablas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    /* Principal: 30% Concepto, 50% Monto, 20% Acciones */
    #expensesTablePrincipal colgroup col:nth-child(1) { width: 30%; }
    #expensesTablePrincipal colgroup col:nth-child(2) { width: 50%; }
    #expensesTablePrincipal colgroup col:nth-child(3) { width: 20%; }
    /* Tarjeta de Cr√©dito: 40% Concepto, 40% Monto, 20% Cuotas */
    #expensesTableCredit colgroup col:nth-child(1) { width: 40%; }
    #expensesTableCredit colgroup col:nth-child(2) { width: 40%; }
    #expensesTableCredit colgroup col:nth-child(3) { width: 20%; }
    /* Otros gastos: 50% Concepto, 50% Monto */
    #expensesTableOtros colgroup col:nth-child(1) { width: 50%; }
    #expensesTableOtros colgroup col:nth-child(2) { width: 50%; }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
      word-wrap: break-word;
    }
    /* Centrar el contenido de la columna de Cuotas en Tarjeta de Cr√©dito */
    #expensesTableCredit td:nth-child(3) {
      text-align: center;
    }
    /* Botones */
    .icon-button {
      border: none;
      background: none;
      padding: 0 5px;
      font-size: 0.65em;
      cursor: pointer;
    }
    .icon-button:disabled {
      cursor: default;
    }
    .pay-icon {
      font-size: 1.3em; /* Doble del tama√±o original */
      display: block;
      margin: auto;
    }
    /* Inputs para edici√≥n inline */
    input[type="text"],
    input[type="number"] {
      padding: 5px;
      font-size: 1em;
      margin: 2px;
      width: 100%;
      box-sizing: border-box;
    }
    /* Secci√≥n para agregar nuevo gasto */
    .addExpenseContainer {
      margin-top: 20px;
      text-align: left;
    }
    .addExpenseContainer h3 {
      margin-bottom: 10px;
    }
    .newConcept { width: 60%; }
    .newAmount { width: 30%; }
    /* Para Tarjeta de Cr√©dito se a√±ade un campo para cuotas */
    .newCuotas { width: 20%; margin-left: 5px; }
    /* Recuadros resumen */
    .summaryBox {
      border: 2px solid #ccc;
      padding: 10px;
      margin-top: 20px;
      border-radius: 5px;
      text-align: left;
      font-size: 1.1em;
    }
    .summaryBox p {
      margin: 5px 0;
    }
    /* Contenedor para respaldos */
    .backupContainer {
      margin-top: 20px;
    }
    .export-btn, .import-btn {
      padding: 5px 10px;
      font-size: 1em;
      cursor: pointer;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <!-- Pesta√±as -->
  <div id="tabContainer">
    <span id="tabPrincipal" class="tab active">Principal</span>
    <span id="tabCredit" class="tab">Tarj. de credit.</span>
    <span id="tabOtros" class="tab">Otros gastos</span>
  </div>

  <!-- Pantalla PRINCIPAL -->
  <div id="screenPrincipal" class="screen active">
    <div id="headerContainer">
      <h1 id="title">Control de gastos</h1>
      <p id="monthInfo">Mes en curso: <span id="currentMonthDisplayPrincipal"></span></p>
      <div id="historialContainerPrincipal">
        <label for="monthSelectPrincipal">Historial:</label>
        <select id="monthSelectPrincipal"></select>
      </div>
    </div>
    <table id="expensesTablePrincipal">
      <colgroup>
        <col style="width:30%;">
        <col style="width:50%;">
        <col style="width:20%;">
      </colgroup>
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerPrincipal">
      <h3>Agregar nuevo gasto</h3>
      <input type="text" id="newConceptPrincipal" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountPrincipal" class="newAmount" placeholder="Monto">
      <button id="addExpenseButtonPrincipal">‚ûï Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxPrincipal"></div>
    <!-- Contenedor para respaldos -->
    <div class="backupContainer">
      <button id="exportBackupButton" class="export-btn">Exportar respaldo</button>
      <button id="importBackupButton" class="import-btn">Importar respaldo</button>
      <input type="file" id="backupFileInput" style="display:none" accept=".json">
    </div>
  </div>

  <!-- Pantalla TARJ. DE CREDIT. -->
  <div id="screenCredit" class="screen">
    <div id="headerContainerCredit">
      <h1 id="titleCredit">Tarj. de credit.</h1>
      <p id="monthInfoCredit">Mes: <span id="currentMonthDisplayCredit"></span></p>
    </div>
    <!-- Tabla con tres columnas: Concepto, Monto y Cuotas -->
    <table id="expensesTableCredit">
      <colgroup>
        <col style="width:40%;">
        <col style="width:40%;">
        <col style="width:20%;">
      </colgroup>
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
          <th>Cuotas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerCredit">
      <h3>Agregar gasto de Tarj. de credit.</h3>
      <input type="text" id="newConceptCredit" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountCredit" class="newAmount" placeholder="Monto">
      <input type="text" id="newCuotasCredit" class="newCuotas" placeholder="Cuotas (ej: 1/6)">
      <button id="addExpenseButtonCredit">‚ûï Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxCredit"></div>
  </div>

  <!-- Pantalla OTROS GASTOS -->
  <div id="screenOtros" class="screen">
    <div id="headerContainerOtros">
      <h1 id="titleOtros">Otros gastos</h1>
      <p id="monthInfoOtros">Mes: <span id="currentMonthDisplayOtros"></span></p>
    </div>
    <!-- Tabla con dos columnas -->
    <table id="expensesTableOtros">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="addExpenseContainer" id="addExpenseContainerOtros">
      <h3>Agregar otro gasto</h3>
      <input type="text" id="newConceptOtros" class="newConcept" placeholder="Concepto">
      <input type="number" id="newAmountOtros" class="newAmount" placeholder="Monto">
      <button id="addExpenseButtonOtros">‚ûï Agregar</button>
    </div>
    <div class="summaryBox" id="summaryBoxOtros"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // Funci√≥n para formatear n√∫meros sin decimales y con separador de miles
      function formatNumber(num) {
        return new Intl.NumberFormat('es-ES', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(num);
      }
      
      /* VARIABLES GLOBALES Y CLAVES */
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth(); // 0-indexado
      const currentMonthName = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][currentMonth];
      const keyPrincipal = `expenses_${currentYear}_${currentMonth+1}`;
      const keyCredit = `credit_${currentYear}_${currentMonth+1}`;
      const keyOtros = `others_${currentYear}_${currentMonth+1}`;
      
      /* DATOS POR DEFECTO */
      const defaultPrincipal = [
        { concept: "Luz", amount: 50, paid: false },
        { concept: "Gas", amount: 30, paid: false },
        { concept: "Tarjeta de Cr√©dito", amount: 0, paid: false },
        { concept: "Agua", amount: 25, paid: false },
        { concept: "Internet", amount: 40, paid: false }
      ];
      const defaultCredit = []; 
      const defaultOtros = [];  
      
      /* FUNCIONES DE ALMACENAMIENTO */
      function loadData(key, defaultData, prefix) {
        const stored = localStorage.getItem(key);
        if (stored) {
          return JSON.parse(stored);
        } else {
          if(prefix === "others") {
            localStorage.setItem(key, JSON.stringify([]));
            return [];
          } else if(prefix === "credit") {
            let parts = key.split("_");
            let year = parseInt(parts[1]);
            let month = parseInt(parts[2]);
            let prevKey = month === 1 ? `${prefix}_${year-1}_12` : `${prefix}_${year}_${month-1}`;
            let prevData = localStorage.getItem(prevKey);
            if (prevData) {
              let data = JSON.parse(prevData)
                .filter(item => item.fixed === true || item.hasOwnProperty("cuotas"))
                .map(item => {
                  let newItem = { ...item, paid: false };
                  if(newItem.hasOwnProperty("cuotas")) {
                    let [currentCuota, totalCuotas] = newItem.cuotas.split("/").map(Number);
                    currentCuota++;
                    if(currentCuota > totalCuotas) {
                      return null;
                    } else {
                      newItem.cuotas = currentCuota + "/" + totalCuotas;
                    }
                  }
                  return newItem;
                })
                .filter(item => item !== null);
              localStorage.setItem(key, JSON.stringify(data));
              return data;
            }
            localStorage.setItem(key, JSON.stringify(defaultData));
            return JSON.parse(JSON.stringify(defaultData));
          } else { // expenses
            let parts = key.split("_");
            let year = parseInt(parts[1]);
            let month = parseInt(parts[2]);
            let prevKey = month === 1 ? `${prefix}_${year-1}_12` : `${prefix}_${year}_${month-1}`;
            let prevData = localStorage.getItem(prevKey);
            if (prevData) {
              let data = JSON.parse(prevData).map(item => ({ ...item, paid: false }));
              localStorage.setItem(key, JSON.stringify(data));
              return data;
            }
            localStorage.setItem(key, JSON.stringify(defaultData));
            return JSON.parse(JSON.stringify(defaultData));
          }
        }
      }
      function saveData(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }
      
      let principalData = loadData(keyPrincipal, defaultPrincipal, "expenses");
      let creditData = loadData(keyCredit, defaultCredit, "credit");
      let otrosData = loadData(keyOtros, defaultOtros, "others");
      
      let editable = true;
      
      function computeSum(data) {
        return data.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
      }
      
      // Funci√≥n para alternar "fixed" en Tarjeta de Cr√©dito
      function toggleFixed(expense, cell) {
        if(expense.hasOwnProperty("cuotas")) return;
        if(expense.fixed === true) {
          if(!confirm("¬øEst√° segura que quiere desmarcar este gasto fijo?")) {
            return;
          }
        }
        expense.fixed = !expense.fixed;
        cell.style.backgroundColor = expense.fixed ? "orange" : "";
        saveData(keyCredit, creditData);
      }
      
      function inlineEditCell(cell, expense, field, index, renderCallback, key, dataArray) {
        if(cell.querySelector("input")) return;
        let currentValue = expense[field].toString();
        let input = document.createElement("input");
        input.type = (field === "amount") ? "number" : "text";
        input.value = currentValue;
        cell.innerHTML = "";
        cell.appendChild(input);
        input.focus();
        input.addEventListener("keydown", function(e) {
          if(e.key === "Enter") { input.blur(); }
        });
        input.addEventListener("blur", function() {
          let newValue = input.value.trim();
          if(newValue === "") {
            if(confirm("¬øEst√° segura de eliminar este registro?")) {
              dataArray.splice(index, 1);
              saveData(key, dataArray);
              renderCallback();
            } else {
              cell.innerHTML = currentValue;
            }
          } else {
            expense[field] = (field === "amount") ? parseFloat(newValue) : newValue;
            saveData(key, dataArray);
            renderCallback();
          }
        });
      }
      
      /* Manejo de pesta√±as */
      document.getElementById("tabPrincipal").addEventListener("click", () => { setActiveTab("Principal"); });
      document.getElementById("tabCredit").addEventListener("click", () => { setActiveTab("Credit"); });
      document.getElementById("tabOtros").addEventListener("click", () => { setActiveTab("Otros"); });
      function setActiveTab(tab) {
        // Forzamos editable = true para poder ingresar datos en todas las pesta√±as.
        editable = true;
        document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".screen").forEach(el => el.classList.remove("active"));
        if(tab === "Principal") {
          document.getElementById("tabPrincipal").classList.add("active");
          document.getElementById("screenPrincipal").classList.add("active");
          renderPrincipal();
        } else if(tab === "Credit") {
          document.getElementById("tabCredit").classList.add("active");
          document.getElementById("screenCredit").classList.add("active");
          renderCredit();
        } else if(tab === "Otros") {
          document.getElementById("tabOtros").classList.add("active");
          document.getElementById("screenOtros").classList.add("active");
          renderOtros();
        }
      }
      
      /* Configuraci√≥n del selector de historial (se muestra un historial de los 12 meses anteriores, incluyendo el actual) */
      function populateMonthSelect(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = "";
        const currentDate = new Date();
        for (let i = 0; i < 12; i++) {
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
          const year = date.getFullYear();
          const month = date.getMonth() + 1; // 1-indexado
          const monthName = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][date.getMonth()];
          const key = `expenses_${year}_${month}`;
          const option = document.createElement("option");
          option.value = key;
          option.textContent = `${monthName} ${year}`;
          if(i === 0) option.selected = true;
          select.appendChild(option);
        }
      }
      populateMonthSelect("monthSelectPrincipal");
      
      document.getElementById("currentMonthDisplayPrincipal").textContent = `${currentMonthName} ${currentYear}`;
      document.getElementById("currentMonthDisplayCredit").textContent = `${currentMonthName} ${currentYear}`;
      document.getElementById("currentMonthDisplayOtros").textContent = `${currentMonthName} ${currentYear}`;
      
      document.getElementById("monthSelectPrincipal").addEventListener("change", function(){
        let selectedKey = this.value;
        principalData = loadData(selectedKey, defaultPrincipal, "expenses");
        let parts = selectedKey.split("_");
        let creditKey = `credit_${parts[1]}_${parts[2]}`;
        let othersKey = `others_${parts[1]}_${parts[2]}`;
        creditData = loadData(creditKey, defaultCredit, "credit");
        otrosData = loadData(othersKey, defaultOtros, "others");
        editable = (selectedKey === keyPrincipal);
        renderPrincipal();
      });
      
      // ---------------------------
      // Datos ficticios para marzo en Tarjeta de Cr√©dito: si es abril y no hay datos para marzo, se inserta 1.856.934.
      if(currentMonth === 3 && !localStorage.getItem(`credit_${currentYear}_3`)) {
        const fictitiousMarch = [
          { concept: "Gastos Fijos", amount: 1856934, paid: true, fixed: true }
        ];
        localStorage.setItem(`credit_${currentYear}_3`, JSON.stringify(fictitiousMarch));
      }
      // ---------------------------
      
      // ---------------------------
      // En la pantalla PRINCIPAL, el valor de "Tarjeta de Cr√©dito" se calcula usando los datos del mes anterior.
      function getPrevCreditKey() {
        if(currentMonth === 0) {
          return `credit_${currentYear-1}_12`;
        } else {
          return `credit_${currentYear}_${currentMonth}`;
        }
      }
      // ---------------------------
      
      /* Renderizado de la pantalla PRINCIPAL */
      function renderPrincipal() {
        const tbody = document.querySelector("#expensesTablePrincipal tbody");
        tbody.innerHTML = "";
        const prevCreditKey = getPrevCreditKey();
        let prevCreditData = JSON.parse(localStorage.getItem(prevCreditKey) || "[]");
        let creditSum = computeSum(prevCreditData);
        let allCreditPaid = prevCreditData.length > 0 && prevCreditData.every(exp => exp.paid);
        
        let creditRow = null, otherRows = [];
        principalData.forEach((expense, index) => {
          if(expense.concept === "Tarjeta de Cr√©dito") {
            creditRow = { expense, index };
          } else {
            otherRows.push({ expense, index });
          }
        });
        
        if(creditRow) {
          const row = document.createElement("tr");
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const actionsCell = document.createElement("td");
          conceptCell.textContent = creditRow.expense.concept;
          amountCell.textContent = "$ " + formatNumber(creditSum);
          const statusButton = document.createElement("button");
          statusButton.innerHTML = allCreditPaid ? "‚úÖ" : "üí≤";
          statusButton.style.color = allCreditPaid ? "#27ae60" : "#e74c3c";
          statusButton.title = allCreditPaid ? "Pagado (click para revertir)" : "Pagar";
          statusButton.classList.add("icon-button", "pay-icon");
          statusButton.addEventListener("click", function() {
            if(allCreditPaid) {
              if(confirm("¬øEst√° segura que quiere cambiar a 'no pagado'?")) {
                prevCreditData.forEach(exp => exp.paid = false);
              }
            } else {
              prevCreditData.forEach(exp => exp.paid = true);
            }
            localStorage.setItem(prevCreditKey, JSON.stringify(prevCreditData));
            renderPrincipal();
          });
          actionsCell.appendChild(statusButton);
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        }
        
        otherRows.forEach(({ expense, index }) => {
          const row = document.createElement("tr");
          row.addEventListener("mousedown", function() {
            this.pressTimer = setTimeout(() => {
              if(confirm("¬øEst√° segura de eliminar este registro?")) {
                principalData.splice(index, 1);
                saveData(keyPrincipal, principalData);
                renderPrincipal();
              }
            }, 1000);
          });
          row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
          row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
          row.addEventListener("touchstart", function() {
            this.pressTimer = setTimeout(() => {
              if(confirm("¬øEst√° segura de eliminar este registro?")) {
                principalData.splice(index, 1);
                saveData(keyPrincipal, principalData);
                renderPrincipal();
              }
            }, 1000);
          });
          row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const actionsCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          conceptCell.addEventListener("click", function() {
            inlineEditCell(conceptCell, expense, "concept", index, renderPrincipal, keyPrincipal, principalData);
          });
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          amountCell.addEventListener("click", function() {
            inlineEditCell(amountCell, expense, "amount", index, renderPrincipal, keyPrincipal, principalData);
          });
          const payButton = document.createElement("button");
          payButton.innerHTML = expense.paid ? "‚úÖ" : "üí≤";
          payButton.style.color = expense.paid ? "#27ae60" : "#e74c3c";
          payButton.title = expense.paid ? "Pagado (click para revertir)" : "Pagar";
          payButton.classList.add("icon-button", "pay-icon");
          payButton.addEventListener("click", function() {
            if(expense.paid) {
              if(confirm("¬øEst√° segura que quiere cambiar a 'no pagado'?")) {
                expense.paid = false;
              }
            } else {
              expense.paid = true;
            }
            saveData(keyPrincipal, principalData);
            renderPrincipal();
          });
          actionsCell.appendChild(payButton);
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });
        
        // Fila fija para "Otros gastos"
        const rowOtros = document.createElement("tr");
        const conceptCellOtros = document.createElement("td");
        conceptCellOtros.textContent = "Otros gastos";
        const othersTotal = computeSum(otrosData);
        const amountCellOtros = document.createElement("td");
        amountCellOtros.textContent = "$ " + formatNumber(othersTotal);
        const actionsCellOtros = document.createElement("td");
        const allOthersPaid = otrosData.length > 0 && otrosData.every(exp => exp.paid);
        const othersPayButton = document.createElement("button");
        othersPayButton.innerHTML = allOthersPaid ? "‚úÖ" : "üí≤";
        othersPayButton.style.color = allOthersPaid ? "#27ae60" : "#e74c3c";
        othersPayButton.title = allOthersPaid ? "Pagado (click para revertir)" : "Pagar";
        othersPayButton.classList.add("icon-button", "pay-icon");
        othersPayButton.addEventListener("click", function() {
          if(allOthersPaid) {
            if(confirm("¬øEst√° segura que quiere cambiar a 'no pagado'?")) {
              otrosData.forEach(exp => exp.paid = false);
            }
          } else {
            otrosData.forEach(exp => exp.paid = true);
          }
          saveData(keyOtros, otrosData);
          renderPrincipal();
          renderOtros();
        });
        actionsCellOtros.appendChild(othersPayButton);
        rowOtros.appendChild(conceptCellOtros);
        rowOtros.appendChild(amountCellOtros);
        rowOtros.appendChild(actionsCellOtros);
        tbody.appendChild(rowOtros);
        
        updateSummaryPrincipal();
        
        // Formulario para agregar en Principal
        const container = document.getElementById("addExpenseContainerPrincipal");
        container.innerHTML = `
          <h3>Agregar nuevo gasto</h3>
          <input type="text" id="newConceptPrincipal" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountPrincipal" class="newAmount" placeholder="Monto">
          <button id="addExpenseButtonPrincipal">‚ûï Agregar</button>
        `;
        document.getElementById("addExpenseButtonPrincipal").addEventListener("click", function(){
          const conceptInput = document.getElementById("newConceptPrincipal");
          const amountInput = document.getElementById("newAmountPrincipal");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto v√°lido y un monto positivo.");
            return;
          }
          principalData.push({ concept: concept, amount: amount, paid: false });
          saveData(keyPrincipal, principalData);
          conceptInput.value = "";
          amountInput.value = "";
          renderPrincipal();
        });
      }
      
      /* Renderizado de la pesta√±a Tarjeta de Cr√©dito */
      function renderCredit() {
        const tbody = document.querySelector("#expensesTableCredit tbody");
        tbody.innerHTML = "";
        creditData.forEach((expense, index) => {
          const row = document.createElement("tr");
          // Permitir eliminar con long press en Tarjeta de Cr√©dito
          if(editable) {
            row.addEventListener("mousedown", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("¬øEst√° segura de eliminar este registro?")) {
                  creditData.splice(index, 1);
                  saveData(keyCredit, creditData);
                  renderCredit();
                }
              }, 1000);
            });
            row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
            row.addEventListener("touchstart", function() {
              this.pressTimer = setTimeout(() => {
                if(confirm("¬øEst√° segura de eliminar este registro?")) {
                  creditData.splice(index, 1);
                  saveData(keyCredit, creditData);
                  renderCredit();
                }
              }, 1000);
            });
            row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          }
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const cuotasCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          // Al tocar el recuadro del concepto se alterna el flag "fixed" (excepto si tiene cuotas)
          conceptCell.addEventListener("click", function() {
            if(expense.hasOwnProperty("cuotas")) return;
            toggleFixed(expense, conceptCell);
          });
          if(expense.fixed === true || expense.hasOwnProperty("cuotas")) {
            conceptCell.style.backgroundColor = "orange";
          } else {
            conceptCell.style.backgroundColor = "";
          }
          // Al tocar el recuadro del monto se marca o desmarca el pago.
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          updateCreditAmountCellStyle(expense, amountCell);
          amountCell.addEventListener("click", function() {
            if(expense.paid) {
              if(!confirm("¬øEst√° segura que quiere desmarcar este pago?")) {
                return;
              }
              expense.paid = false;
            } else {
              expense.paid = true;
            }
            saveData(keyCredit, creditData);
            updateCreditAmountCellStyle(expense, amountCell);
          });
          cuotasCell.textContent = expense.hasOwnProperty("cuotas") ? expense.cuotas : "";
          cuotasCell.addEventListener("click", function() {
            inlineEditCell(cuotasCell, expense, "cuotas", index, renderCredit, keyCredit, creditData);
          });
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          row.appendChild(cuotasCell);
          tbody.appendChild(row);
        });
        updateSummaryCredit();
        const container = document.getElementById("addExpenseContainerCredit");
        container.innerHTML = `
          <h3>Agregar gasto de Tarj. de credit.</h3>
          <input type="text" id="newConceptCredit" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountCredit" class="newAmount" placeholder="Monto">
          <input type="text" id="newCuotasCredit" class="newCuotas" placeholder="Cuotas (ej: 1/6)">
          <button id="addExpenseButtonCredit">‚ûï Agregar</button>
        `;
        document.getElementById("addExpenseButtonCredit").addEventListener("click", function(){
          const conceptInput = document.getElementById("newConceptCredit");
          const amountInput = document.getElementById("newAmountCredit");
          const cuotasInput = document.getElementById("newCuotasCredit");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          const cuotas = cuotasInput.value.trim();
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto v√°lido y un monto positivo.");
            return;
          }
          let newExpense = { concept: concept, amount: amount, paid: false };
          if(cuotas !== "") {
            newExpense.cuotas = cuotas;
            newExpense.fixed = true;
          }
          creditData.push(newExpense);
          saveData(keyCredit, creditData);
          conceptInput.value = "";
          amountInput.value = "";
          cuotasInput.value = "";
          renderCredit();
          renderPrincipal();
        });
      }
      
      // Funci√≥n para actualizar el estilo del monto en Tarj. de Cr√©dito
      function updateCreditAmountCellStyle(expense, cell) {
        if(expense.paid) {
          cell.style.backgroundColor = "#d4f7d4"; // verde clarito
          if(!cell.innerHTML.includes("‚úÖ")) {
            cell.innerHTML = "$ " + formatNumber(expense.amount) + " ‚úÖ";
          }
        } else {
          cell.style.backgroundColor = "";
          cell.innerHTML = "$ " + formatNumber(expense.amount);
        }
      }
      
      function updateSummaryCredit() {
        let total = creditData.length > 0 ? computeSum(creditData) : 0;
        let summaryHTML = `<p>üí∞ Total Tarj. de credit: $${formatNumber(total)}</p>`;
        document.getElementById("summaryBoxCredit").innerHTML = summaryHTML;
        document.getElementById("summaryBoxCredit").style.backgroundColor = "#e0ffe0";
      }
      
      /* Renderizado de la pesta√±a Otros gastos */
      function renderOtros() {
        const tbody = document.querySelector("#expensesTableOtros tbody");
        tbody.innerHTML = "";
        otrosData.forEach((expense, index) => {
          const row = document.createElement("tr");
          row.addEventListener("mousedown", function() {
            this.pressTimer = setTimeout(() => {
              if(confirm("¬øEst√° segura de eliminar este registro?")) {
                otrosData.splice(index, 1);
                saveData(keyOtros, otrosData);
                renderOtros();
              }
            }, 1000);
          });
          row.addEventListener("mouseup", function() { clearTimeout(this.pressTimer); });
          row.addEventListener("mouseleave", function() { clearTimeout(this.pressTimer); });
          row.addEventListener("touchstart", function() {
            this.pressTimer = setTimeout(() => {
              if(confirm("¬øEst√° segura de eliminar este registro?")) {
                otrosData.splice(index, 1);
                saveData(keyOtros, otrosData);
                renderOtros();
              }
            }, 1000);
          });
          row.addEventListener("touchend", function() { clearTimeout(this.pressTimer); });
          const conceptCell = document.createElement("td");
          const amountCell = document.createElement("td");
          conceptCell.textContent = expense.concept;
          conceptCell.addEventListener("click", function() {
            inlineEditCell(conceptCell, expense, "concept", index, renderOtros, keyOtros, otrosData);
          });
          amountCell.textContent = "$ " + formatNumber(expense.amount);
          amountCell.addEventListener("click", function() {
            inlineEditCell(amountCell, expense, "amount", index, renderOtros, keyOtros, otrosData);
          });
          row.appendChild(conceptCell);
          row.appendChild(amountCell);
          tbody.appendChild(row);
        });
        updateSummaryOtros();
        const container = document.getElementById("addExpenseContainerOtros");
        container.innerHTML = `
          <h3>Agregar otro gasto</h3>
          <input type="text" id="newConceptOtros" class="newConcept" placeholder="Concepto">
          <input type="number" id="newAmountOtros" class="newAmount" placeholder="Monto">
          <button id="addExpenseButtonOtros">‚ûï Agregar</button>
        `;
        document.getElementById("addExpenseButtonOtros").addEventListener("click", function(){
          const conceptInput = document.getElementById("newConceptOtros");
          const amountInput = document.getElementById("newAmountOtros");
          const concept = conceptInput.value.trim();
          const amount = parseFloat(amountInput.value);
          if(concept === "" || isNaN(amount) || amount < 0) {
            alert("Ingresa un concepto v√°lido y un monto positivo.");
            return;
          }
          otrosData.push({ concept: concept, amount: amount, paid: false });
          saveData(keyOtros, otrosData);
          conceptInput.value = "";
          amountInput.value = "";
          renderOtros();
        });
      }
      
      function updateSummaryOtros() {
        let total = otrosData.length > 0 ? computeSum(otrosData) : 0;
        let summaryHTML = `<p>üí∞ Total otros gastos: $${formatNumber(total)}</p>`;
        document.getElementById("summaryBoxOtros").innerHTML = summaryHTML;
        document.getElementById("summaryBoxOtros").style.backgroundColor = "#e0ffe0";
      }
      
      document.getElementById("addExpenseButtonPrincipal").addEventListener("click", function(){
        const conceptInput = document.getElementById("newConceptPrincipal");
        const amountInput = document.getElementById("newAmountPrincipal");
        const concept = conceptInput.value.trim();
        const amount = parseFloat(amountInput.value);
        if(concept === "" || isNaN(amount) || amount < 0) {
          alert("Ingresa un concepto v√°lido y un monto positivo.");
          return;
        }
        principalData.push({ concept: concept, amount: amount, paid: false });
        saveData(keyPrincipal, principalData);
        conceptInput.value = "";
        amountInput.value = "";
        renderPrincipal();
      });
      
      /* Funciones de respaldo: Exportar e Importar */
      function exportBackup() {
        const backupData = {
          principal: principalData,
          credit: creditData,
          others: otrosData
        };
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `respaldo_${currentYear}_${currentMonth+1}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      function importBackup(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            if(data.principal && data.credit && data.others) {
              localStorage.setItem(keyPrincipal, JSON.stringify(data.principal));
              localStorage.setItem(keyCredit, JSON.stringify(data.credit));
              localStorage.setItem(keyOtros, JSON.stringify(data.others));
              principalData = data.principal;
              creditData = data.credit;
              otrosData = data.others;
              renderPrincipal();
              renderCredit();
              renderOtros();
              alert("Respaldo importado exitosamente.");
            } else {
              alert("El archivo no contiene datos v√°lidos.");
            }
          } catch (err) {
            alert("Error al leer el archivo.");
          }
        };
        reader.readAsText(file);
      }
      
      document.getElementById("exportBackupButton").addEventListener("click", function() {
        exportBackup();
      });
      
      document.getElementById("importBackupButton").addEventListener("click", function() {
        document.getElementById("backupFileInput").click();
      });
      
      document.getElementById("backupFileInput").addEventListener("change", function(e) {
        if(e.target.files.length > 0) {
          importBackup(e.target.files[0]);
        }
      });
      
      /* Exportaci√≥n autom√°tica el primer d√≠a de cada mes */
      if(new Date().getDate() === 1) {
        exportBackup();
      }
      
      // ---------------------------
      // Datos ficticios para marzo en Tarjeta de Cr√©dito:
      // Si es abril y no existen datos para marzo, se inserta 1.856.934.
      if(currentMonth === 3 && !localStorage.getItem(`credit_${currentYear}_3`)) {
        const fictitiousMarch = [
          { concept: "Gastos Fijos", amount: 1856934, paid: true, fixed: true }
        ];
        localStorage.setItem(`credit_${currentYear}_3`, JSON.stringify(fictitiousMarch));
      }
      // ---------------------------
      
      // ---------------------------
      // En la pantalla PRINCIPAL, el valor de "Tarjeta de Cr√©dito" se calcula usando los datos del mes anterior.
      function getPrevCreditKey() {
        if(currentMonth === 0) {
          return `credit_${currentYear-1}_12`;
        } else {
          return `credit_${currentYear}_${currentMonth}`;
        }
      }
      // ---------------------------
      
      // Forzamos la activaci√≥n de la pesta√±a Principal al cargar la p√°gina.
      setActiveTab("Principal");
    });
  </script>
</body>
</html>
